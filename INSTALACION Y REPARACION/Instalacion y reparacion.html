

<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>HVAC Bar – Editor (GeraValon)</title>
<style>
  :root{
    --bg:#0d1117; --panel:#161b22; --border:#30363d;
    --text:#e6edf3; --muted:#8b949e; --accent:#2ea043;

    --c-camp:#2ea043; --c-box:#58a6ff; --c-fan:#d29922;
    --c-fil:#a371f7; --c-carbon:#9da7b3;
    --c-piece:#ff7b72; --c-duct:#c9d1d9; --c-grille:#79c0ff;
  }
  *{ box-sizing:border-box; }
  body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text); }

  header{
    padding:10px 12px; border-bottom:1px solid var(--border);
    background:var(--panel); display:flex; flex-wrap:wrap; gap:8px; align-items:center;
    position:sticky; top:0; z-index:10;
  }
  button{
    background:#21262d; color:var(--text); border:1px solid var(--border);
    padding:8px 10px; border-radius:10px; cursor:pointer; font-weight:650; font-size:13px;
  }
  button:hover{ filter:brightness(1.08); }
 .wrap{
  display:grid;
  grid-template-columns: auto 1fr;
  gap:12px;
  padding:12px;
}
  .panel{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:12px;
  padding:12px;

  resize: horizontal;
  overflow: auto;

  min-width:220px;
  max-width:420px;
}
  .grid{ display:grid; gap:10px; }
  .row{ display:flex; gap:10px; align-items:center; }
  label{ color:var(--muted); font-size:12px; display:block; margin-bottom:4px; }
  input, select{
    width:100%; background:#0b1220; color:var(--text); border:1px solid var(--border);
    border-radius:10px; padding:8px 10px; outline:none;
  }
  input:focus, select:focus{ border-color:#4b5563; box-shadow:0 0 0 2px rgba(46,160,67,.15); }
  .muted{ color:var(--muted); font-size:12px; line-height:1.35; }

  #stageWrap{ background:var(--panel); border:1px solid var(--border); border-radius:12px; overflow:hidden; }
  svg{ width:100%; height: calc(100vh - 120px); display:block; background:#0b1220; }

  /* Grid */
  .gridline{ stroke:#1f2733; stroke-width:1; }

  /* Items */
  .item .shape{ stroke:#c9d1d9; stroke-width:2; fill:rgba(255,255,255,.03); }
  .item text{ fill:#c9d1d9; font-size:12px; user-select:none; }
  .selected .shape{ stroke: var(--accent) !important; }

  /* Accents by type */
  .accent.campana{ stroke: var(--c-camp); }
  .accent.caja{ stroke: var(--c-box); }
  .accent.vent{ stroke: var(--c-fan); }
  .accent.filtronic{ stroke: var(--c-fil); }
  .accent.carbon{ stroke: var(--c-carbon); }
  .accent.conducto{ stroke: var(--c-duct); }
  .accent.pieza{ stroke: var(--c-piece); }
  .accent.rejilla{ stroke: var(--c-grille); }

  /* Overlay selection box + handles */
  .selbox{ fill:none; stroke: var(--accent); stroke-width:1.5; stroke-dasharray:4 3; pointer-events:none; }
  .handle{ fill: var(--accent); stroke:#0b1220; stroke-width:2; cursor:nwse-resize; }
  .handle.ns{ cursor:ns-resize; }
  .handle.ew{ cursor:ew-resize; }

  /* Rotate handle */
  .rotline{ stroke: var(--accent); stroke-width:2; }
  .rothandle{ fill: var(--accent); stroke:#0b1220; stroke-width:2; cursor:grab; }

  @media (max-width: 980px){
    .wrap{ grid-template-columns: 1fr; }
    svg{ height: 70vh; }
  }

  /* PRINT / PDF */
  @media print{
    header, .panel{ display:none !important; }
    body{ background:white; color:black; }
    #stageWrap{ border:none; }
    svg{ height: auto; background:white !important; }
  }
</style>
</head>
<body>

<header>
  <button id="addCampana">+ Campana</button>
  <button id="addCaja">+ Caja ventilación</button>
  <button id="addVent">+ Vent. centrífugo</button>
  <button id="addCampVent">+ Campana+vent.</button>
  <button id="addFiltronic">+ Filtronic</button>
  <button id="addCarbon">+ Cajón carbón</button>

  <button id="addConducto">+ Conducto</button>
  <button id="addFlex">+ Flexible</button>
  <button id="addCodo90">+ Codo 90°</button>
  <button id="addCodo45">+ Codo 45°</button>
  <button id="addT">+ T</button>
  <button id="addRed">+ Reducción</button>
  <button id="addRejilla">+ Rejilla</button>

  <button id="btnRot90">Rotar 90°</button>
  <button id="btnDelete">Eliminar</button>

   <button id="addTexto">+ Texto</button>


  <button id="btnExportSvg">Exportar SVG</button>
  <button id="btnSave">Guardar JSON</button>
  <button id="btnLoad">Cargar JSON</button>
  <input id="fileLoad" type="file" accept="application/json" style="display:none"/>

  <span class="muted">Arrastra. Tiradores = tamaño. Maneta arriba = rotar. Doble click texto = editar.</span>
</header>

<div class="wrap">
  <div class="panel">
    <div class="grid">

      <div class="row">
        <div style="flex:1">
          <label>Snap</label>
          <select id="snap">
            <option value="0">Sin snap</option>
            <option value="5">5 px</option>
            <option value="10" selected>10 px</option>
            <option value="20">20 px</option>
          </select>
        </div>
        <div style="flex:1">
          <label>Zoom</label>
          <input id="zoom" type="range" min="60" max="160" value="100"/>
        </div>
      </div>

      <div>
        <label>Texto / Propiedades (seleccionado)</label>
        <input id="label" placeholder="Ej: Q=2500 m³/h · Ø315 · F400 · filtros=4…"/>
      </div>

      <div class="row">
        <div style="flex:1">
          <label>Ancho base</label>
          <input id="w" type="number" step="1" placeholder="auto"/>
        </div>
        <div style="flex:1">
          <label>Alto base</label>
          <input id="h" type="number" step="1" placeholder="auto"/>
        </div>
      </div>

      <div class="muted">
        - El tamaño real se hace con tiradores (escala).<br>
        - Ancho/Alto base re-dibuja el “marco” principal (rectángulo base).<br>
        - Rotación: maneta (círculo arriba) o botón 90°.<br>
        - Si cargas JSON antiguo: “t” → “tee”, “reduccion” → “red”, “flexible” → “flex”.<br>
      </div>
    </div>
  </div>

  <div id="stageWrap">
    <svg id="svg" viewBox="0 0 1600 950" xmlns="http://www.w3.org/2000/svg">
      <g id="grid"></g>
      <g id="items"></g>
      <g id="overlay"></g>
    </svg>
  </div>
</div>

<script>
(() => {
  const NS = "http://www.w3.org/2000/svg";
  const svg = document.getElementById("svg");
  const gridG = document.getElementById("grid");
  const itemsG = document.getElementById("items");
  const overlay = document.getElementById("overlay");

  const snapSel = document.getElementById("snap");
  const zoom = document.getElementById("zoom");
  const inpLabel = document.getElementById("label");
  const inpW = document.getElementById("w");
  const inpH = document.getElementById("h");
  const fileLoad = document.getElementById("fileLoad");

  const el = (n)=>document.createElementNS(NS,n);
  const rect = (x,y,w,h,rx=10)=>{ const r=el("rect"); r.setAttribute("x",x); r.setAttribute("y",y); r.setAttribute("width",w); r.setAttribute("height",h); r.setAttribute("rx",rx); r.setAttribute("ry",rx); return r; };
  const line = (x1,y1,x2,y2)=>{ const l=el("line"); l.setAttribute("x1",x1); l.setAttribute("y1",y1); l.setAttribute("x2",x2); l.setAttribute("y2",y2); return l; };
  const circle = (cx,cy,r)=>{ const c=el("circle"); c.setAttribute("cx",cx); c.setAttribute("cy",cy); c.setAttribute("r",r); return c; };
  const path = (d)=>{ const p=el("path"); p.setAttribute("d",d); return p; };
  const text = (x,y,txt)=>{ const t=el("text"); t.setAttribute("x",x); t.setAttribute("y",y); t.textContent=txt; t.dataset.role="label"; return t; };

  function drawGrid(step=40){
    gridG.innerHTML="";
    const vb = svg.viewBox.baseVal;
    for(let x=0;x<=vb.width;x+=step){ const l=line(x,0,x,vb.height); l.classList.add("gridline"); gridG.appendChild(l); }
    for(let y=0;y<=vb.height;y+=step){ const l=line(0,y,vb.width,y); l.classList.add("gridline"); gridG.appendChild(l); }
  }
  drawGrid(40);

  function snap(v){ const s=parseInt(snapSel.value,10); return s? Math.round(v/s)*s : v; }

  function svgPoint(evt){
    const pt = svg.createSVGPoint();
    pt.x = evt.clientX; pt.y = evt.clientY;
    return pt.matrixTransform(svg.getScreenCTM().inverse());
  }

  function angleDeg(cx,cy,x,y){
    return Math.atan2(y-cy, x-cx) * 180 / Math.PI;
  }

  function applyTransform(g){
    const x=+g.dataset.x||0;
    const y=+g.dataset.y||0;
    const r=+g.dataset.r||0;
    const sx=+g.dataset.sx||1;
    const sy=+g.dataset.sy||1;
    const w=+g.dataset.w||0;
    const h=+g.dataset.h||0;
    const cx=w/2, cy=h/2;
    g.setAttribute("transform", `translate(${x},${y}) rotate(${r},${cx},${cy}) scale(${sx},${sy})`);
  }

  function biggestRect(g){
    const rects=[...g.querySelectorAll("rect")];
    if(!rects.length) return null;
    rects.sort((a,b)=>(b.width.baseVal.value*b.height.baseVal.value)-(a.width.baseVal.value*a.height.baseVal.value));
    return rects[0];
  }

  // ===== ELBOW (CODO) path centrado para que el BBOX empiece en (0,0) incluso en 45° =====
  function elbowPath(angleDeg_, R, w){
    const a = angleDeg_ * Math.PI / 180;

    const rOut = R + w/2;
    const rIn  = Math.max(2, R - w/2);

    // puntos (codo en 1er cuadrante)
    const x1o = rOut, y1o = 0;
    const x2o = rOut * Math.cos(a), y2o = rOut * Math.sin(a);

    const x2i = rIn * Math.cos(a),  y2i = rIn * Math.sin(a);
    const x1i = rIn,  y1i = 0;

    // compensación: para 45° el minX NO es 0
    const minX = Math.min(x2o, x2i, x1i, x1o);
    const dx = -minX;
    const dy = 0;

    return {
      d: `
        M ${x1o+dx} ${y1o+dy}
        A ${rOut} ${rOut} 0 0 1 ${x2o+dx} ${y2o+dy}
        L ${x2i+dx} ${y2i+dy}
        A ${rIn} ${rIn} 0 0 0 ${x1i+dx} ${y1i+dy}
        Z
      `,
      w: (rOut - minX),
      h: (rOut * Math.sin(a))
    };
  }

  let selected=null;
  let drag=null;
  let resizing=null;
  let rotating=null;

  function clearOverlay(){ overlay.innerHTML=""; }

  function getWorldCenter(g){
    const w = +g.dataset.w||0, h = +g.dataset.h||0;
    const x = (+g.dataset.x||0) + (w/2);
    const y = (+g.dataset.y||0) + (h/2);
    return {x,y};
  }

  function select(g){
    if(selected) selected.classList.remove("selected");
    selected=g;
    clearOverlay();

    if(!selected){
      inpLabel.value=""; inpW.value=""; inpH.value="";
      return;
    }

    selected.classList.add("selected");
    const t=selected.querySelector('[data-role="label"]');
    inpLabel.value = t ? t.textContent : "";
    inpW.value = selected.dataset.w || "";
    inpH.value = selected.dataset.h || "";
    drawOverlay(selected);
  }

  function bindItem(g){
    g.addEventListener("mousedown",(e)=>{
      if(e.button!==0) return;
      select(g);
      const p=svgPoint(e);
      drag={ g, startX:p.x, startY:p.y, ox:+g.dataset.x, oy:+g.dataset.y };
    });

    g.addEventListener("dblclick",()=>{
  const t=g.querySelector('[data-role="label"]');
  if(!t) return;

  const current = [...t.querySelectorAll("tspan")].map(s=>s.textContent).join("\n");
  const val = prompt("Editar texto (usa ENTER para salto de línea):", current);
  if(val===null) return;

  t.innerHTML = "";
  val.split("\n").forEach((ln,i)=>{
    const sp = el("tspan");
    sp.setAttribute("x","10");
    sp.setAttribute("dy", i===0 ? "0" : "18");
    sp.textContent = ln;
    t.appendChild(sp);
  });

  inpLabel.value = val;
});
  }

  function drawOverlay(g){
    clearOverlay();

    const bb = g.getBBox();
    const og = el("g");
    og.setAttribute("transform", g.getAttribute("transform"));

    const box = rect(bb.x, bb.y, bb.width, bb.height, 0);
    box.classList.add("selbox");
    og.appendChild(box);

    // resize handles (8)
    const pts = [
      {k:"nw", x:bb.x, y:bb.y, cls:""},
      {k:"n",  x:bb.x+bb.width/2, y:bb.y, cls:"ns"},
      {k:"ne", x:bb.x+bb.width, y:bb.y, cls:""},
      {k:"e",  x:bb.x+bb.width, y:bb.y+bb.height/2, cls:"ew"},
      {k:"se", x:bb.x+bb.width, y:bb.y+bb.height, cls:""},
      {k:"s",  x:bb.x+bb.width/2, y:bb.y+bb.height, cls:"ns"},
      {k:"sw", x:bb.x, y:bb.y+bb.height, cls:""},
      {k:"w",  x:bb.x, y:bb.y+bb.height/2, cls:"ew"},
    ];
    pts.forEach(p=>{
      const h = rect(p.x-6, p.y-6, 12, 12, 3);
      h.classList.add("handle");
      if(p.cls) h.classList.add(p.cls);
      h.dataset.handle=p.k;
      h.addEventListener("mousedown",(e)=>{
        e.stopPropagation();
        const sp=svgPoint(e);
        resizing={ g, handle:p.k, startX:sp.x, startY:sp.y, sx:+g.dataset.sx, sy:+g.dataset.sy };
      });
      og.appendChild(h);
    });

    // rotate handle
    const cx = bb.x + bb.width/2;
    const top = bb.y;
    const ry = top - 28;
    const stem = line(cx, top, cx, ry);
    stem.classList.add("rotline");
    const rh = circle(cx, ry, 8);
    rh.classList.add("rothandle");

    rh.addEventListener("mousedown",(e)=>{
      e.stopPropagation();
      const sp = svgPoint(e);
      const center = getWorldCenter(g);
      const ang0 = angleDeg(center.x, center.y, sp.x, sp.y);
      rotating = { g, center, startAng: ang0, startR: (+g.dataset.r||0) };
    });

    og.appendChild(stem);
    og.appendChild(rh);

    overlay.appendChild(og);
  }

  // ====== ELEMENTOS ======
  function makeItem(kind){
    const g = el("g");
    g.classList.add("item");
    g.dataset.kind = kind;
    g.dataset.x="140"; g.dataset.y="140";
    g.dataset.r="0"; g.dataset.sx="1"; g.dataset.sy="1";

    const setWH = (w,h)=>{ g.dataset.w=String(w); g.dataset.h=String(h); };
    const addLabel = (txt)=> g.appendChild(text(10,18,txt));

    if(kind==="campana"){
      setWH(280,95);
      const r = rect(0,0,280,95,12); r.classList.add("shape","accent","campana");
      g.appendChild(r);
      for(let i=0;i<4;i++){
        const f = rect(14+i*62, 38, 50, 40, 6);
        f.classList.add("shape");
        f.setAttribute("fill","rgba(46,160,67,.08)");
        f.setAttribute("stroke","rgba(46,160,67,.7)");
        g.appendChild(f);
      }
      addLabel("CAMPANA · filtros=4 · Q=…");
    } else if(kind==="caja"){
      setWH(240,130);
      const r = rect(0,0,240,130,12); r.classList.add("shape","accent","caja");
      const mid = rect(22,38,196,70,10); mid.classList.add("shape");
      mid.setAttribute("fill","rgba(88,166,255,.08)");
      mid.setAttribute("stroke","rgba(88,166,255,.7)");
      g.append(r, mid);
      addLabel("CAJA VENTILACIÓN · Q=…");
    } else if(kind==="vent"){
      setWH(150,150);
      const r = rect(0,0,150,150,16); r.classList.add("shape","accent","vent");
      const c = circle(75,75,46); c.classList.add("shape");
      c.setAttribute("fill","rgba(210,153,34,.08)");
      c.setAttribute("stroke","rgba(210,153,34,.7)");
      const p = path("M 75 34 L 112 75 L 75 116 L 38 75 Z");
      p.classList.add("shape");
      p.setAttribute("fill","rgba(210,153,34,.06)");
      p.setAttribute("stroke","rgba(210,153,34,.6)");
      g.append(r,c,p);
      addLabel("VENT. CENTRÍFUGO · F400?");
    } else if(kind==="campvent"){
      setWH(300,120);
      const r = rect(0,0,300,120,12); r.classList.add("shape","accent","campana");
      const box = rect(185,25,95,70,12); box.classList.add("shape","accent","vent");
      box.setAttribute("fill","rgba(210,153,34,.05)");
      const fan = circle(232,60,22); fan.classList.add("shape");
      fan.setAttribute("fill","rgba(210,153,34,.08)");
      fan.setAttribute("stroke","rgba(210,153,34,.7)");
      g.append(r, box, fan);
      addLabel("CAMPANA + VENT. · Q=…");
    } else if(kind==="filtronic"){
      setWH(260,130);
      const r = rect(0,0,260,130,12); r.classList.add("shape","accent","filtronic");
      const grid = rect(18,40,224,70,10); grid.classList.add("shape");
      grid.setAttribute("fill","rgba(163,113,247,.08)");
      grid.setAttribute("stroke","rgba(163,113,247,.7)");
      const bolt = path("M 130 34 L 108 78 L 132 78 L 112 118 L 162 66 L 136 66 Z");
      bolt.classList.add("shape");
      bolt.setAttribute("fill","rgba(163,113,247,.08)");
      bolt.setAttribute("stroke","rgba(163,113,247,.7)");
      g.append(r, grid, bolt);
      addLabel("FILTRONIC · modelo=…");
    } else if(kind==="carbon"){
      setWH(280,120);
      const r = rect(0,0,280,120,12); r.classList.add("shape","accent","carbon");
      const fill = rect(18,40,244,70,10); fill.classList.add("shape");
      fill.setAttribute("fill","rgba(157,167,179,.10)");
      fill.setAttribute("stroke","rgba(157,167,179,.7)");
      g.append(r, fill);
      addLabel("CAJÓN CARBÓN · kg=…");
    } else if(kind==="conducto"){
      setWH(360,60);
      const r = rect(0,0,360,60,10); r.classList.add("shape","accent","conducto");
      r.setAttribute("fill","rgba(255,255,255,.02)");
      g.appendChild(r);
      addLabel("CONDUCTO · Ø… · EI…");
    } else if(kind==="flex"){
      setWH(290,52);
      const r = rect(0,0,290,52,26); r.classList.add("shape","accent","conducto");
      r.setAttribute("fill","rgba(255,255,255,.015)");
      g.appendChild(r);
      for(let x=14;x<290;x+=18){
        const l=line(x,10,x,42);
        l.classList.add("shape");
        l.setAttribute("stroke","rgba(201,209,217,.35)");
        l.setAttribute("stroke-width","2");
        g.appendChild(l);
      }
      addLabel("FLEXIBLE · Ø…");
     } else if(kind==="texto"){
  setWH(520,160);

  // caja invisible (solo para poder seleccionar/redimensionar)
  const hit = rect(0,0,520,160,0);
  hit.classList.add("shape");
  hit.setAttribute("fill","transparent");
  hit.setAttribute("stroke","transparent");
  g.appendChild(hit);

  // texto multilínea
  const t = el("text");
  t.setAttribute("x","10");
  t.setAttribute("y","22");
  t.dataset.role="label";

  const lines = "ESCRIBE AQUÍ...\nLÍNEA 2\nLÍNEA 3".split("\n");
  lines.forEach((ln,i)=>{
    const sp = el("tspan");
    sp.setAttribute("x","10");
    sp.setAttribute("dy", i===0 ? "0" : "18");
    sp.textContent = ln;
    t.appendChild(sp);
  });

  g.appendChild(t);
    } else if(kind==="codo90"){
      const R=90, W=50, ang=90;
      const obj = elbowPath(ang, R, W);
      setWH(Math.max(80,obj.w), Math.max(80,obj.h));
      const p = path(obj.d);
      p.classList.add("shape","accent","pieza");
      p.setAttribute("fill","rgba(255,123,114,.06)");
      g.appendChild(p);
      addLabel(`CODO 90° · Ø${W}`);
    } else if(kind==="codo45"){
      const R=110, W=50, ang=45;
      const obj = elbowPath(ang, R, W);
      setWH(Math.max(80,obj.w), Math.max(80,obj.h));
      const p = path(obj.d);
      p.classList.add("shape","accent","pieza");
      p.setAttribute("fill","rgba(255,123,114,.06)");
      g.appendChild(p);
      addLabel(`CODO 45° · Ø${W}`);
    } else if(kind==="tee"){
  // T real: rama solo hacia arriba (no “+”)
  const W = 210;
  const H_MAIN = 42;
  const H_BRANCH = 70;
  const BR = 10;

  const TOTAL_H = H_BRANCH + H_MAIN;
  setWH(W, TOTAL_H);

  const main = rect(0, H_BRANCH, W, H_MAIN, BR);
  main.classList.add("shape","accent","pieza");
  main.setAttribute("fill","rgba(255,123,114,.04)");

  const branchW = 42;
  const branchX = (W - branchW) / 2;
  const branch = rect(branchX, 0, branchW, H_BRANCH, BR);
  branch.classList.add("shape","accent","pieza");
  branch.setAttribute("fill","rgba(255,123,114,.04)");

  g.append(main, branch);
  addLabel("T · Ø…/Ø…");

} else if(kind==="red"){
  // Reducción troncocónica
  const W = 260;
  const H1 = 110;
  const H2 = 70;
  const ring = 10;
  setWH(W, H1);

  const base = rect(0,0,W,H1,8);
  base.setAttribute("fill","none");
  base.setAttribute("stroke","none");
  g.appendChild(base);

  const y2 = (H1 - H2) / 2;

  const body = path(`
    M ${ring} 0
    L ${W-ring} ${y2}
    L ${W-ring} ${y2+H2}
    L ${ring} ${H1}
    Z
  `);
  body.classList.add("shape","accent","pieza");
  body.setAttribute("fill","rgba(255,123,114,.06)");

  g.appendChild(body);
  addLabel("REDUCCIÓN · ØA→ØB");
    } else if(kind==="rejilla"){
      setWH(190,75);
      const r = rect(0,0,190,75,10); r.classList.add("shape","accent","rejilla");
      r.setAttribute("fill","rgba(121,192,255,.05)");
      g.appendChild(r);
      for(let x=16;x<180;x+=14){
        const l=line(x,14,x,62);
        l.classList.add("shape");
        l.setAttribute("stroke","rgba(121,192,255,.55)");
        l.setAttribute("stroke-width","2");
        g.appendChild(l);
      }
      addLabel("REJILLA SALIDA · Ø…");
    } else {
      // fallback
      setWH(180,80);
      const r = rect(0,0,180,80,12); r.classList.add("shape");
      g.appendChild(r);
      addLabel("ELEMENTO");
    }

    applyTransform(g);
    bindItem(g);
    return g;
  }

  // ====== MOUSE MOVE / DRAG / RESIZE / ROTATE ======
  svg.addEventListener("mousemove",(e)=>{
    if(drag){
      const p=svgPoint(e);
      const nx=snap(drag.ox + (p.x-drag.startX));
      const ny=snap(drag.oy + (p.y-drag.startY));
      drag.g.dataset.x=nx; drag.g.dataset.y=ny;
      applyTransform(drag.g);
      drawOverlay(drag.g);
      return;
    }
    if(resizing){
      const p=svgPoint(e);
      const dx=p.x-resizing.startX;
      const dy=p.y-resizing.startY;
      const k=0.005;
      let nsx=resizing.sx, nsy=resizing.sy;

      if(["e","ne","se"].includes(resizing.handle)) nsx=Math.max(0.2, resizing.sx + dx*k);
      if(["w","nw","sw"].includes(resizing.handle)) nsx=Math.max(0.2, resizing.sx - dx*k);
      if(["s","se","sw"].includes(resizing.handle)) nsy=Math.max(0.2, resizing.sy + dy*k);
      if(["n","ne","nw"].includes(resizing.handle)) nsy=Math.max(0.2, resizing.sy - dy*k);

      resizing.g.dataset.sx=nsx;
      resizing.g.dataset.sy=nsy;
      applyTransform(resizing.g);
      drawOverlay(resizing.g);
      return;
    }
    if(rotating){
      const p=svgPoint(e);
      const ang = angleDeg(rotating.center.x, rotating.center.y, p.x, p.y);
      const delta = ang - rotating.startAng;
      const nr = rotating.startR + delta;
      rotating.g.dataset.r = nr;
      applyTransform(rotating.g);
      drawOverlay(rotating.g);
      return;
    }
  });

  window.addEventListener("mouseup",()=>{ drag=null; resizing=null; rotating=null; });

  svg.addEventListener("mousedown",(e)=>{
    if(e.target===svg || e.target===gridG) select(null);
  });

  // ===== PANEL BINDINGS =====
  inpLabel.addEventListener("input",()=>{
    if(!selected) return;
    const t=selected.querySelector('[data-role="label"]');
    if(t) t.textContent=inpLabel.value;
  });

  function applyWH(){
    if(!selected) return;
    const w=parseFloat(inpW.value);
    const h=parseFloat(inpH.value);
    if(!Number.isFinite(w) || !Number.isFinite(h)) return;

    selected.dataset.w=w;
    selected.dataset.h=h;

    const br = biggestRect(selected);
    if(br){
      br.setAttribute("width", w);
      br.setAttribute("height", h);
    }
    applyTransform(selected);
    drawOverlay(selected);
  }
  inpW.addEventListener("change", applyWH);
  inpH.addEventListener("change", applyWH);

  zoom.addEventListener("input",()=>{
    const z=parseInt(zoom.value,10)/100;
    svg.style.transformOrigin="0 0";
    svg.style.transform=`scale(${z})`;
  });

  // ===== ADD HELPER =====
  function add(kind){
    const g=makeItem(kind);
    const n=itemsG.children.length;
    g.dataset.x = 140 + (n*18)%360;
    g.dataset.y = 140 + (n*18)%260;
    applyTransform(g);
    itemsG.appendChild(g);
    select(g);
  }

  // ===== BUTTONS =====
  document.getElementById("addCampana").onclick=()=>add("campana");
  document.getElementById("addCaja").onclick=()=>add("caja");
  document.getElementById("addVent").onclick=()=>add("vent");
  document.getElementById("addCampVent").onclick=()=>add("campvent");
  document.getElementById("addFiltronic").onclick=()=>add("filtronic");
  document.getElementById("addCarbon").onclick=()=>add("carbon");

  document.getElementById("addConducto").onclick=()=>add("conducto");
  document.getElementById("addFlex").onclick=()=>add("flex");
  document.getElementById("addCodo90").onclick=()=>add("codo90");
  document.getElementById("addCodo45").onclick=()=>add("codo45");
  document.getElementById("addT").onclick=()=>add("tee");
  document.getElementById("addRed").onclick=()=>add("red");
  document.getElementById("addRejilla").onclick=()=>add("rejilla");

  document.getElementById("addTexto").onclick=()=>add("texto");

  document.getElementById("btnRot90").onclick=()=>{
    if(!selected) return;
    const r=((+selected.dataset.r||0)+90)%360;
    selected.dataset.r=r;
    applyTransform(selected);
    drawOverlay(selected);
  };

  document.getElementById("btnDelete").onclick=()=>{
    if(!selected) return;
    selected.remove();
    select(null);
  };

 

 // Export SVG (con estilos + fondo oscuro)
document.getElementById("btnExportSvg").onclick = () => {

  // 1) clonar el SVG
  const clone = svg.cloneNode(true);

  // 2) quitar overlay (caja/handles)
  const ov = clone.querySelector("#overlay");
  if (ov) ov.remove();

  // 3) quitar selección
  clone.querySelectorAll(".selected").forEach(n => n.classList.remove("selected"));

  // 4) insertar fondo oscuro para que se vea igual que en pantalla
  const vb = clone.viewBox.baseVal;
  const bg = document.createElementNS(NS, "rect");
  bg.setAttribute("x", vb.x);
  bg.setAttribute("y", vb.y);
  bg.setAttribute("width", vb.width);
  bg.setAttribute("height", vb.height);
  bg.setAttribute("fill", "#0b1220");
  clone.insertBefore(bg, clone.firstChild);

  // 5) incrustar los estilos del <style> del HTML dentro del SVG
  const css = document.querySelector("style")?.textContent || "";
  const styleEl = document.createElementNS(NS, "style");
  styleEl.textContent = css;
  clone.insertBefore(styleEl, clone.firstChild);

  // 6) descargar
  const data = new XMLSerializer().serializeToString(clone);
  const blob = new Blob([data], { type: "image/svg+xml" });

  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "hvac-esquema.svg";
  a.click();
  URL.revokeObjectURL(a.href);
};

  // Save / Load JSON (con alias)
  const kindMap = {
    "t":"tee", "tee":"tee",
    "reduccion":"red", "red":"red",
    "flexible":"flex", "flex":"flex"
  };

  document.getElementById("btnSave").onclick=()=>{
    const arr=[...itemsG.querySelectorAll("g.item")].map(g=>{
      const t=g.querySelector('[data-role="label"]');
      return {
        kind:g.dataset.kind,
        x:+g.dataset.x, y:+g.dataset.y,
        r:+g.dataset.r, sx:+g.dataset.sx, sy:+g.dataset.sy,
        w:+g.dataset.w, h:+g.dataset.h,
        label:(t?t.textContent:"")
      };
    });
    const blob=new Blob([JSON.stringify(arr,null,2)],{type:"application/json"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download="hvac-proyecto.json";
    a.click();
    URL.revokeObjectURL(a.href);
  };

  document.getElementById("btnLoad").onclick=()=>fileLoad.click();
  fileLoad.addEventListener("change", async ()=>{
    const f=fileLoad.files[0];
    if(!f) return;

    let data;
    try{ data=JSON.parse(await f.text()); }catch{ alert("JSON inválido"); return; }

    itemsG.innerHTML="";
    select(null);

    for(const it of data){
      const raw = (it.kind||"");
      const k = kindMap[String(raw).toLowerCase()] || raw;

      const g=makeItem(k);
      itemsG.appendChild(g);

      g.dataset.x=it.x||0; g.dataset.y=it.y||0;
      g.dataset.r=it.r||0; g.dataset.sx=it.sx||1; g.dataset.sy=it.sy||1;
      g.dataset.w=it.w||g.dataset.w; g.dataset.h=it.h||g.dataset.h;

      const t=g.querySelector('[data-role="label"]');
      if(t && it.label) t.textContent=it.label;

      const br = biggestRect(g);
      if(br && it.w && it.h){
        br.setAttribute("width", it.w);
        br.setAttribute("height", it.h);
      }
      applyTransform(g);
    }

    fileLoad.value="";
  });

  // ===== INIT =====
 // add("conducto");
})();
</script>
</body>
</html>
