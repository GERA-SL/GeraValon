
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SERVICIOS VARIOS – GeraValon</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0d1117;
      --panel:#161b22;
      --border:#30363d;
      --text:#e6edf3;
      --muted:#8b949e;
      --hover:#0f1623;
      --project:#a371f7;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family:'Inter', system-ui, sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    header{
      padding:18px 24px;
      border-bottom:1px solid var(--border);
      background:var(--panel);
    }

    .header-row{
      display:flex;
      align-items:center;
      gap:14px;
      max-width:900px;
      margin:0 auto;
    }

    .icon{
      width:30px;
      height:30px;
      border-radius:6px;
      background:var(--project);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      font-size:14px;
      color:#0b0f14;
    }

    h1{
      margin:0;
      font-size:20px;
      font-weight:600;
      letter-spacing:.4px;
    }

    main{
      max-width:900px;
      margin:0 auto;
      padding:24px;
    }

    .block{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:10px;
      padding:20px;
      margin-bottom:24px;
    }

    .block-title{
      font-size:14px;
      font-weight:600;
      margin-bottom:16px;
      color:var(--muted);
      letter-spacing:.3px;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-bottom:16px;
    }

    label{
      font-size:13px;
      color:var(--muted);
    }

    input, select{
      background:#0f1623;
      border:1px solid var(--border);
      border-radius:8px;
      padding:10px 12px;
      color:var(--text);
      font-size:14px;
    }

    input:focus, select:focus{
      outline:none;
      border-color:var(--project);
    }

    select:disabled, input:disabled{
      opacity:.55;
      cursor:not-allowed;
    }

    .row-fields{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:16px;
    }

    @media (max-width: 700px){
      .row-fields{ grid-template-columns: 1fr; }
    }

    .btn-row{
      display:flex;
      gap:10px;
      margin-top:10px;
      flex-wrap:wrap;
    }

    button{
      border:1px solid var(--border);
      background:#0f1623;
      color:var(--text);
      padding:10px 12px;
      border-radius:8px;
      font-size:13px;
      cursor:pointer;
    }
    button:hover{ border-color:var(--project); }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .hint{
      margin-top:14px;
      color:var(--muted);
      font-size:13px;
    }

    /* ====== BLOQUE 3 TABLA RESUMEN ====== */
    table{
      width:100%;
      border-collapse:collapse;
      overflow:hidden;
      border-radius:10px;
      border:1px solid var(--border);
    }
    th, td{
      border-bottom:1px solid var(--border);
      padding:10px 10px;
      font-size:13px;
      vertical-align:top;
    }
    th{
      text-align:left;
      color:var(--muted);
      font-weight:600;
      background:rgba(255,255,255,.02);
    }
    tr:hover td{ background:rgba(255,255,255,.02); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    /* ====== MODAL ====== */
    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.6);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:999;
    }
    .modal{
      width:min(900px, 100%);
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:12px;
      overflow:hidden;
    }
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(180deg, rgba(163,113,247,.10), rgba(0,0,0,0));
    }
    .modal-title{
      margin:0;
      font-size:14px;
      font-weight:600;
      letter-spacing:.2px;
    }
    .modal-sub{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
    }
    .modal-body{
      padding:16px;
      max-height:75vh;
      overflow:auto;
    }
    .modal-footer{
      padding:12px 16px;
      border-top:1px solid var(--border);
      display:flex;
      justify-content:flex-end;
      gap:10px;
      background:rgba(255,255,255,.01);
    }

    .grid-2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 700px){
      .grid-2{ grid-template-columns: 1fr; }
    }

    .small{
      font-size:12px;
      color:var(--muted);
      margin: 4px 0 10px;
    }

    .section-title{
      margin: 10px 0 10px;
      font-size:13px;
      color:var(--muted);
      font-weight:600;
      letter-spacing:.2px;
    }

    .mini-table{
      width:100%;
      border:1px solid var(--border);
      border-radius:10px;
      overflow:hidden;
    }
    .mini-table .row{
      display:grid;
      grid-template-columns: 1.2fr .6fr;
      gap:10px;
      padding:10px;
      border-bottom:1px solid var(--border);
      align-items:center;
    }
    .mini-table .row:last-child{ border-bottom:none; }
    .mini-table .row-3{
      grid-template-columns: .6fr 1.4fr;
    }
    .mini-table .head{
      background:rgba(255,255,255,.02);
      font-weight:600;
      color:var(--muted);
      font-size:12px;
    }
  </style>
</head>

<body>

<header>
  <div class="header-row">
    <div class="icon">S</div>
    <h1>SERVICIOS VARIOS</h1>
  </div>
</header>

<main>

  <!-- BLOQUE 1 -->
  <div class="block">
    <div class="block-title">DATOS GENERALES</div>
    <div class="row-fields">
      <div class="field">
        <label for="fecha">FECHA</label>
        <input type="date" id="fecha">
      </div>
      <div class="field">
        <label for="cliente">CLIENTE</label>
        <input type="text" id="cliente" placeholder="Nombre del cliente">
      </div>
      <div class="field">
        <label for="ref">REFERENCIA (opcional)</label>
        <input type="text" id="ref" placeholder="Ej. Parte / pedido / etc.">
      </div>
    </div>
  </div>

  <!-- BLOQUE 2 -->
  <div class="block">
    <div class="block-title">TIPO DE SERVICIO</div>

    <div id="lineas-servicio">
      <!-- línea base (se clona) -->
      <div class="row-fields linea-servicio">
        <div class="field">
          <label>CATEGORÍA</label>
          <select class="categoria" onchange="actualizarSubtipoLinea(this)">
            <option value="">Selecciona categoría</option>
            <option value="filtracion">FILTRACIÓN</option>
            <option value="extraccion">SISTEMA DE EXTRACCIÓN</option>
            <option value="grasa">SEPARADOR DE GRASA</option>
            <option value="ventilacion">VENTILACIÓN</option>
          </select>
        </div>

        <div class="field">
          <label>SUBTIPO</label>
          <select class="subtipo" disabled>
            <option value="">Selecciona primero una categoría</option>
          </select>
        </div>

        <div class="field">
          <label>DETALLE</label>
          <input type="text" class="detalle" placeholder="Observaciones / notas">
        </div>
      </div>
    </div>

    <div class="btn-row">
      <button type="button" onclick="agregarLinea()">GENERAR OTRA LÍNEA</button>
      <button type="button" onclick="aceptarLineas()">ACEPTAR</button>
      <button type="button" onclick="resetTodo()">REINICIAR</button>
    </div>

    <div class="hint">
      Escribe una línea y pulsa “GENERAR OTRA LÍNEA” para añadir debajo (4 veces o las que quieras).
      Luego “ACEPTAR” elimina las vacías y te pide los gastos de cada tarea.
    </div>
  </div>

  <!-- BLOQUE 3 -->
  <div class="block">
    <div class="block-title">RESUMEN (BLOQUE 3)</div>

    <div id="resumen-vacio" class="hint">Aún no hay resumen. Pulsa ACEPTAR en el Bloque 2.</div>

    <div id="resumen-tabla" style="display:none;">
      <table>
        <thead>
          <tr>
            <th style="width:28%;">TAREA</th>
            <th style="width:26%;">OPERARIOS / HORAS</th>
            <th style="width:16%;">DESPLAZAMIENTO</th>
            <th style="width:18%;">MATERIAL + OTROS</th>
            <th style="width:12%;">TOTAL €</th>
          </tr>
        </thead>
        <tbody id="tbody-resumen"></tbody>
      </table>
    </div>
  </div>

</main>

<!-- MODAL GASTOS -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-header">
      <div>
        <div class="modal-title" id="modalTitulo">TAREA</div>
        <div class="modal-sub" id="modalSub">Introduce los gastos de esta línea</div>
      </div>
      <div class="mono" id="modalContador"></div>
    </div>

    <div class="modal-body">
      <div class="small" id="modalDetalleLinea"></div>

      <div class="section-title">OPERARIOS</div>
      <div class="mini-table" id="tablaOperarios">
        <div class="row head">
          <div>OPERARIO</div>
          <div>HORAS</div>
        </div>
        <!-- filas operarios -->
      </div>

      <div class="section-title">DESPLAZAMIENTO</div>
      <div class="grid-2">
        <div class="field">
          <label>KM</label>
          <input type="number" id="km" min="0" step="0.1" placeholder="0">
        </div>
        <div class="field">
          <label>TIPO</label>
          <select id="tipoKm">
            <option value="">(opcional)</option>
            <option value="coche">Coche</option>
            <option value="furgoneta">Furgoneta</option>
            <option value="moto">Moto</option>
            <option value="otro">Otro</option>
          </select>
        </div>
      </div>

      <div class="section-title">GASTO DE MATERIAL</div>
      <div class="mini-table" id="tablaMaterial">
        <div class="row head row-3">
          <div>€</div>
          <div>CONCEPTO</div>
        </div>
        <!-- filas material -->
      </div>

      <div class="section-title">OTROS GASTOS</div>
      <div class="mini-table" id="tablaOtros">
        <div class="row head row-3">
          <div>€</div>
          <div>CONCEPTO</div>
        </div>
        <!-- filas otros -->
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" onclick="cerrarModal(false)">Cancelar</button>
      <button type="button" onclick="aceptarGastosLinea()">ACEPTAR</button>
    </div>
  </div>
</div>

<script>
  /* =========================
     1) SUBTIPOS POR CATEGORÍA
  ========================== */
  const subtipos = {
    filtracion: [
      "FILTROS DE CAMPANA",
      "FILTROS DE FILTRONIC",
      "CARCASA DE FILTRONIC"
    ],
    extraccion: [
      "CAMPANA",
      "CAJA DE VENTILACION",
      "CONDUCTOS",
      "COCINA",
      "OTROS"
    ],
    grasa: [
      "MENOS DE 80 LITROS",
      "MAYOR DE 80 LITROS"
    ],
    ventilacion: [
      "CAJA DE VENTILACION",
      "CONDUCTOS",
      "REJILLAS",
      "OTROS"
    ]
  };

  function actualizarSubtipoLinea(selectCategoria){
    const linea = selectCategoria.closest(".linea-servicio");
    const subtipoSel = linea.querySelector(".subtipo");
    const categoria = selectCategoria.value;

    subtipoSel.innerHTML = "";

    if(!categoria || !subtipos[categoria]){
      subtipoSel.disabled = true;
      subtipoSel.innerHTML = "<option value=''>Selecciona primero una categoría</option>";
      return;
    }

    subtipoSel.disabled = false;

    const first = document.createElement("option");
    first.value = "";
    first.textContent = "Selecciona subtipo";
    subtipoSel.appendChild(first);

    subtipos[categoria].forEach(opcion => {
      const opt = document.createElement("option");
      opt.value = opcion;
      opt.textContent = opcion;
      subtipoSel.appendChild(opt);
    });
  }

  function agregarLinea(){
    const contenedor = document.getElementById("lineas-servicio");
    const base = contenedor.querySelector(".linea-servicio");
    const nueva = base.cloneNode(true);

    // limpiar valores
    nueva.querySelector(".categoria").value = "";
    const st = nueva.querySelector(".subtipo");
    st.innerHTML = "<option value=''>Selecciona primero una categoría</option>";
    st.disabled = true;
    nueva.querySelector(".detalle").value = "";

    contenedor.appendChild(nueva);
  }

  /* =========================
     2) ACEPTAR: limpiar + cola modales
  ========================== */
  function lineaEstaVacia(linea){
    const cat = (linea.querySelector(".categoria")?.value || "").trim();
    const sub = (linea.querySelector(".subtipo")?.value || "").trim();
    const det = (linea.querySelector(".detalle")?.value || "").trim();

    // consideramos vacía si no hay nada significativo
    if(cat === "" && sub === "" && det === "") return true;

    // si solo escribió espacios
    if(cat === "" && sub === "" && det.length < 2) return true;

    return false;
  }

  function aceptarLineas(){
    const contenedor = document.getElementById("lineas-servicio");
    const lineas = Array.from(contenedor.querySelectorAll(".linea-servicio"));

    // eliminar vacías
    lineas.forEach(l => { if(lineaEstaVacia(l)) l.remove(); });

    // re-leer
    const restantes = Array.from(contenedor.querySelectorAll(".linea-servicio"));

    if(restantes.length === 0){
      alert("No hay líneas válidas. Escribe al menos una tarea.");
      return;
    }

    // bloquear bloque 2
    document.querySelectorAll("#lineas-servicio select, #lineas-servicio input").forEach(el => el.disabled = true);

    // preparar lista de tareas para pedir gastos
    tareas = restantes.map((linea, idx) => {
      const catVal = linea.querySelector(".categoria").value;
      const subVal = linea.querySelector(".subtipo").value;
      const detVal = linea.querySelector(".detalle").value;

      const catLabel = categoriaLabel(catVal);
      const tareaLabel = `${catLabel} – ${subVal || "(sin subtipo)"}`;

      return {
        idx,
        catVal,
        catLabel,
        subVal,
        detVal,
        tareaLabel
      };
    });

    // reset de gastos previos
    gastosPorTarea = [];
    tareaActual = 0;

    // abrir primer modal
    abrirModalParaTarea(0);
  }

  function categoriaLabel(catVal){
    switch(catVal){
      case "filtracion": return "FILTRACIÓN";
      case "extraccion": return "SISTEMA DE EXTRACCIÓN";
      case "grasa": return "SEPARADOR DE GRASA";
      case "ventilacion": return "VENTILACIÓN";
      default: return "CATEGORÍA";
    }
  }

  /* =========================
     3) MODAL: construir formulario por tarea
  ========================== */
  const modalOverlay = document.getElementById("modalOverlay");
  const modalTitulo = document.getElementById("modalTitulo");
  const modalSub = document.getElementById("modalSub");
  const modalContador = document.getElementById("modalContador");
  const modalDetalleLinea = document.getElementById("modalDetalleLinea");

  const tablaOperarios = document.getElementById("tablaOperarios");
  const tablaMaterial = document.getElementById("tablaMaterial");
  const tablaOtros = document.getElementById("tablaOtros");

  // Ajusta aquí tus operarios reales cuando quieras
  const operarios = ["", "Operario 1", "Operario 2", "Operario 3", "Operario 4", "Operario 5"];

  let tareas = [];
  let tareaActual = 0;
  let gastosPorTarea = [];

  function abrirModalParaTarea(i){
    const t = tareas[i];
    modalTitulo.textContent = t.tareaLabel;
    modalSub.textContent = "Introduce los gastos de esta tarea";
    modalContador.textContent = `${i+1}/${tareas.length}`;
    modalDetalleLinea.textContent = t.detVal ? `Detalle: ${t.detVal}` : "";

    // reset campos
    document.getElementById("km").value = "";
    document.getElementById("tipoKm").value = "";

    // construir 5 filas operarios
    limpiarFilas(tablaOperarios, 1); // deja la cabecera
    for(let r=0; r<5; r++){
      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `
        <div>
          <select class="op-nombre">
            ${operarios.map(o => `<option value="${escapeHtml(o)}">${escapeHtml(o || "(vacío)")}</option>`).join("")}
          </select>
        </div>
        <div><input type="number" class="op-horas" min="0" step="0.25" placeholder="0"></div>
      `;
      tablaOperarios.appendChild(row);
    }

    // construir 5 filas material
    limpiarFilas(tablaMaterial, 1);
    for(let r=0; r<5; r++){
      const row = document.createElement("div");
      row.className = "row row-3";
      row.innerHTML = `
        <div><input type="number" class="mat-eur" min="0" step="0.01" placeholder="0"></div>
        <div><input type="text" class="mat-con" placeholder="Concepto"></div>
      `;
      tablaMaterial.appendChild(row);
    }

    // construir 5 filas otros
    limpiarFilas(tablaOtros, 1);
    for(let r=0; r<5; r++){
      const row = document.createElement("div");
      row.className = "row row-3";
      row.innerHTML = `
        <div><input type="number" class="otr-eur" min="0" step="0.01" placeholder="0"></div>
        <div><input type="text" class="otr-con" placeholder="Concepto"></div>
      `;
      tablaOtros.appendChild(row);
    }

    modalOverlay.style.display = "flex";
  }

  function limpiarFilas(tabla, cabe = 0){
    // deja cabe filas (cabecera)
    const rows = Array.from(tabla.querySelectorAll(".row"));
    rows.forEach((r, idx) => {
      if(idx >= cabe) r.remove();
    });
  }

  function cerrarModal(confirmado){
    modalOverlay.style.display = "none";
    if(!confirmado){
      // si cancelas, no rompe nada: vuelves a editar (desbloquea) para no quedarse a medias
      document.querySelectorAll("#lineas-servicio select, #lineas-servicio input").forEach(el => el.disabled = false);
      alert("Cancelado. Bloque 2 reabierto para corregir.");
    }
  }

  function aceptarGastosLinea(){
    const t = tareas[tareaActual];

    // leer operarios
    const opRows = Array.from(tablaOperarios.querySelectorAll(".row")).slice(1); // sin cabecera
    const ops = opRows.map(r => {
      const nombre = r.querySelector(".op-nombre").value.trim();
      const horas = parseFloat(r.querySelector(".op-horas").value || "0");
      return { nombre, horas: isNaN(horas) ? 0 : horas };
    }).filter(x => (x.nombre && x.nombre !== "") || x.horas > 0);

    // km
    const km = parseFloat(document.getElementById("km").value || "0");
    const tipoKm = document.getElementById("tipoKm").value || "";
    const kmVal = isNaN(km) ? 0 : km;

    // material
    const matRows = Array.from(tablaMaterial.querySelectorAll(".row")).slice(1);
    const material = matRows.map(r => {
      const eur = parseFloat(r.querySelector(".mat-eur").value || "0");
      const con = (r.querySelector(".mat-con").value || "").trim();
      return { eur: isNaN(eur) ? 0 : eur, con };
    }).filter(x => x.eur > 0 || x.con.length > 0);

    // otros
    const otrRows = Array.from(tablaOtros.querySelectorAll(".row")).slice(1);
    const otros = otrRows.map(r => {
      const eur = parseFloat(r.querySelector(".otr-eur").value || "0");
      const con = (r.querySelector(".otr-con").value || "").trim();
      return { eur: isNaN(eur) ? 0 : eur, con };
    }).filter(x => x.eur > 0 || x.con.length > 0);

    const totalMaterial = material.reduce((s,x)=> s + (x.eur||0), 0);
    const totalOtros = otros.reduce((s,x)=> s + (x.eur||0), 0);

    gastosPorTarea.push({
      tareaLabel: t.tareaLabel,
      detalle: t.detVal,
      operarios: ops,
      km: kmVal,
      tipoKm,
      material,
      otros,
      totalMaterial,
      totalOtros,
      total: totalMaterial + totalOtros
    });

    // siguiente tarea o cerrar
    tareaActual++;
    if(tareaActual < tareas.length){
      abrirModalParaTarea(tareaActual);
    } else {
      modalOverlay.style.display = "none";
      construirResumen();
      alert("Gastos guardados. Revisa el Bloque 3 (Resumen).");
    }
  }

  /* =========================
     4) BLOQUE 3: construir tabla resumen
  ========================== */
  function construirResumen(){
    const tbody = document.getElementById("tbody-resumen");
    tbody.innerHTML = "";

    gastosPorTarea.forEach(g => {
      const opsTxt = (g.operarios && g.operarios.length)
        ? g.operarios.map(o => `${escapeHtml(o.nombre || "(sin nombre)")}: ${fmt(o.horas)}h`).join("<br>")
        : "<span style='color:var(--muted)'>—</span>";

      const despTxt = (g.km && g.km > 0)
        ? `${fmt(g.km)} km ${g.tipoKm ? "(" + escapeHtml(g.tipoKm) + ")" : ""}`
        : "<span style='color:var(--muted)'>—</span>";

      const matTxt = []
      if(g.material.length){
        matTxt.push(`<div><b>Material:</b> ${fmtEur(g.totalMaterial)}</div>`);
      }
      if(g.otros.length){
        matTxt.push(`<div><b>Otros:</b> ${fmtEur(g.totalOtros)}</div>`);
      }
      const matHtml = matTxt.length ? matTxt.join("") : "<span style='color:var(--muted)'>—</span>";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><div><b>${escapeHtml(g.tareaLabel)}</b></div>${g.detalle ? `<div class="small">${escapeHtml(g.detalle)}</div>` : ""}</td>
        <td>${opsTxt}</td>
        <td>${despTxt}</td>
        <td>${matHtml}</td>
        <td class="mono">${fmtEur(g.total)}</td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById("resumen-vacio").style.display = "none";
    document.getElementById("resumen-tabla").style.display = "block";
  }

  function fmt(n){
    const x = Number(n || 0);
    return (Math.round(x*100)/100).toFixed(2).replace(".", ",");
  }

  function fmtEur(n){
    return `${fmt(n)} €`;
  }

  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  /* =========================
     5) REINICIAR
  ========================== */
  function resetTodo(){
    // desbloquear
    document.querySelectorAll("#lineas-servicio select, #lineas-servicio input").forEach(el => el.disabled = false);

    // dejar solo una línea
    const contenedor = document.getElementById("lineas-servicio");
    const lineas = Array.from(contenedor.querySelectorAll(".linea-servicio"));
    lineas.forEach((l, idx) => { if(idx>0) l.remove(); });

    // limpiar primera
    const base = contenedor.querySelector(".linea-servicio");
    base.querySelector(".categoria").value = "";
    const st = base.querySelector(".subtipo");
    st.innerHTML = "<option value=''>Selecciona primero una categoría</option>";
    st.disabled = true;
    base.querySelector(".detalle").value = "";

    // limpiar resumen
    document.getElementById("tbody-resumen").innerHTML = "";
    document.getElementById("resumen-vacio").style.display = "block";
    document.getElementById("resumen-tabla").style.display = "none";

    tareas = [];
    gastosPorTarea = [];
    tareaActual = 0;

    // datos generales opcional: no los borro, si quieres los borro también
  }
</script>

</body>
</html>
